{% extends 'main.html' %}
{% block title %}Student Dashboard{% endblock %}
{% block content %}

<h2 class="mb-4 text-success">My Dashboard</h2>
<p class="text-muted">Welcome, {{ request.user.get_username }}</p>

<!-- Django Messages -->
{% if messages %}
<div class="mb-3">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
</div>
{% endif %}

<!-- Today's Attendance -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">Today's Attendance</div>
    <div class="card-body">
        {% if today_record %}
            <p><strong>Status:</strong> {{ today_record.status }}</p>
            <p><strong>Check-in:</strong> {{ today_record.check_in|default:"—" }}</p>
            <p><strong>Check-out:</strong> {{ today_record.check_out|default:"—" }}</p>
            {% if today_record.location %}
                <p><strong>Location:</strong> {{ today_record.location.name }}</p>
            {% endif %}
        {% else %}
            <p class="text-muted">No record yet for today.</p>
        {% endif %}

        <!-- Actions -->
        <div class="d-flex gap-2 mt-3">
            <!-- Check In -->
            <form id="checkInForm" action="{% url 'attendance:check_in' %}" method="post" class="d-flex align-items-center">
                {% csrf_token %}
                <label for="location" class="me-2">Select Lab:</label>
                <select name="location" id="location" required class="form-select w-auto">
                    <option value="" disabled selected>-- Choose --</option>
                    {% for loc in locations %}
                        <option value="{{ loc.id }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="latitude" id="latitude">
                <input type="hidden" name="longitude" id="longitude">
                <button type="submit" id="checkInBtn" class="btn btn-success ms-2" disabled>
                    Check In
                </button>
            </form>

            <!-- Check Out -->
            <form id="checkOutForm" action="{% url 'attendance:check_out' %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" id="checkOutBtn" class="btn btn-danger" {% if not today_record or not today_record.check_in or today_record.check_out %}disabled{% endif %}>
                    Check Out
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Recent Records -->
<div class="card shadow-sm">
    <div class="card-header bg-success text-white">My Recent Attendance</div>
    <div class="card-body table-responsive">
        <table class="table table-striped align-middle">
            <thead class="table-success">
                <tr>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Check-in</th>
                    <th>Check-out</th>
                    <th>Location</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr>
                    <td>{{ record.date }}</td>
                    <td>{{ record.status }}</td>
                    <td>{{ record.check_in|default:"—" }}</td>
                    <td>{{ record.check_out|default:"—" }}</td>
                    <td>{{ record.location.name|default:"—" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted">No attendance records found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
const locationSelect = document.getElementById("location");
const checkInBtn = document.getElementById("checkInBtn");
const latitudeField = document.getElementById("latitude");
const longitudeField = document.getElementById("longitude");

// Enable Check In button only if lab is selected and GPS is available
locationSelect.addEventListener("change", () => {
    if (locationSelect.value !== "" && latitudeField.value && longitudeField.value) {
        checkInBtn.disabled = false;
    } else {
        checkInBtn.disabled = true;
    }
});

// Fetch GPS automatically when page loads
window.onload = function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            latitudeField.value = position.coords.latitude;
            longitudeField.value = position.coords.longitude;

            // Enable Check In if a location is already selected
            if (locationSelect.value !== "") {
                checkInBtn.disabled = false;
            }
        }, function(error) {
            alert("❌ Unable to get location. Please allow GPS.");
        });
    } else {
        alert("❌ Geolocation is not supported by this browser.");
    }
};
</script>

{% endblock %}
